# Setup & Configuration — @atscript/typescript

> Installation, configuration file, TypeScript plugin options, and CLI usage.

## Installation

```bash
pnpm add @atscript/typescript @atscript/core
# or
npm install @atscript/typescript @atscript/core
```

For build-tool integration (Vite, Webpack, Rollup, esbuild, Rspack):

```bash
pnpm add unplugin-atscript
```

## Configuration File

Create `atscript.config.ts` (or `.js`, `.mjs`) in your project root:

```ts
import { defineConfig } from '@atscript/core'
import tsPlugin from '@atscript/typescript'

export default defineConfig({
  // Root directory for resolving .as files (defaults to cwd)
  rootDir: '.',

  // Entry points — glob patterns for .as files to compile
  entries: ['src/**/*.as'],

  // Include/exclude globs for dependency resolution
  include: ['src/**/*.as'],
  exclude: ['node_modules/**'],

  // Plugins — tsPlugin is the TypeScript language extension
  plugins: [tsPlugin()],

  // How to handle unknown annotations: 'allow' | 'warn' | 'error'
  unknownAnnotation: 'warn',

  // Custom primitives (merged with built-in ones)
  primitives: {},

  // Custom annotations (merged with built-in ones)
  annotations: {},
})
```

### `TAtscriptConfig` Fields

| Field | Type | Description |
|-------|------|-------------|
| `rootDir` | `string` | Root directory for resolving files |
| `entries` | `string[]` | Entry point globs for `.as` files |
| `include` | `string[]` | Include globs |
| `exclude` | `string[]` | Exclude globs |
| `plugins` | `TAtscriptPlugin[]` | Build plugins (e.g. `tsPlugin()`) |
| `primitives` | `Record<string, TPrimitiveConfig>` | Custom primitive type definitions |
| `annotations` | `TAnnotationsTree` | Custom annotation definitions |
| `unknownAnnotation` | `'allow' \| 'warn' \| 'error'` | Unknown annotation handling |
| `format` | `string` | Output format (set by CLI or build tool) |
| `outDir` | `string` | Output directory |

## TypeScript Plugin Options

```ts
tsPlugin({
  jsonSchema: false    // default — toJsonSchema() throws at runtime
  // jsonSchema: 'lazy'   — import buildJsonSchema, compute on demand, cache
  // jsonSchema: 'bundle' — pre-compute at build time, embed in output

  exampleData: false   // default — toExampleData() not rendered
  // exampleData: true  — render toExampleData() using createDataFromAnnotatedType
})
```

### `jsonSchema`

Individual interfaces can override the JSON Schema setting with `@emit.jsonSchema` annotation to force build-time embedding regardless of plugin setting.

### `exampleData`

Controls whether `toExampleData()` is generated on output classes:
- `false` *(default)* — method is not rendered in `.js`; `.d.ts` marks it as optional + `@deprecated`
- `true` — each class gets `static toExampleData()` that calls `createDataFromAnnotatedType(this, { mode: 'example' })`, creating a new example data object on each call (no caching)

## Build Tool Integration

### Vite

```ts
// vite.config.ts
import atscript from 'unplugin-atscript/vite'

export default {
  plugins: [atscript()]
}
```

### Webpack

```ts
// webpack.config.js
const atscript = require('unplugin-atscript/webpack')
module.exports = {
  plugins: [atscript()]
}
```

The unplugin automatically compiles `.as` files during development and build, generating `.as.js` modules that are importable.

## CLI — `asc`

The `asc` CLI compiles `.as` files outside of build tools (e.g. for generating `.d.ts` files).

```bash
# Generate .d.ts files (most common use case)
npx asc -f dts

# Generate .js files
npx asc -f js

# Use a specific config file
npx asc -c atscript.config.ts

# Only run diagnostics, no file output
npx asc --noEmit

# Skip diagnostics, always emit
npx asc --skipDiag
```

### Why run `npx asc -f dts`?

This generates two things:
1. **`*.as.d.ts`** files next to each `.as` file — TypeScript type declarations for all interfaces/types
2. **`atscript.d.ts`** in the project root — global type declarations for `AtscriptMetadata` and `AtscriptPrimitiveTags`

The `atscript.d.ts` file is **crucial for type safety** — it tells TypeScript about all annotations used in your project, enabling type-safe metadata access at runtime.

### CLI Options

| Option | Short | Description |
|--------|-------|-------------|
| `--config <path>` | `-c` | Path to config file |
| `--format <fmt>` | `-f` | Output format: `dts`, `js` |
| `--noEmit` | | Only check for errors |
| `--skipDiag` | | Skip diagnostics, always emit |

## Project Structure Example

```
my-project/
  atscript.config.ts      ← config file
  atscript.d.ts           ← generated by `npx asc -f dts` (global types)
  src/
    models/
      user.as             ← source file
      user.as.d.ts        ← generated type declarations
      user.as.js          ← generated runtime module (by build tool)
```
